<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Farm Fun — Tap & Learn</title>
<style>
  :root{
    --skyTop:#bfe9ff; --skyMid:#aee0ff; --fieldFar:#92dc7a;
    --hillFar:#6fb866; --hillMid:#65ad5c; --hillNear:#5aa454;
    --pond:#97d9ff;
    --barnBody:#b23a48; --barnBodyShade:#992d3a; --barnTrim:#7a2028; --barnRoof:#8a2731;
    --millPost:#cfcfcf; --millBladeA:#e9ecef; --millBladeB:#dfe4ea;
    --wood:#c79a69; --woodDark:#a97e52;
    --panel:#ffffffee; --ink:#1f2937; --shadow:#00000024; --sun:#ffd166;

    --cloudMin: 32s; --cloudMax: 85s;
  }

  html,body{height:100%;margin:0}
  body{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;
    color:var(--ink);
    background:linear-gradient(180deg,var(--skyTop) 0 45%, var(--skyMid) 45% 60%, var(--fieldFar) 60% 100%);
    overflow:hidden;
    touch-action: manipulation;
  }

  /* Layers */
  .layer{position:absolute; inset:auto 0; pointer-events:none}
  .sky-sun{position:absolute; right:4vw; top:5vh; width:160px; height:160px; border-radius:50%;
           background:radial-gradient(circle at 45% 45%, #fff8 0 18%, var(--sun) 19% 100%);
           box-shadow:0 0 80px 30px #ffd16666; z-index:0; filter:blur(.2px);}
  .clouds{top:6vh; bottom:auto; z-index:1;}
  .hills-far{bottom:34vh; z-index:1}
  .hills-mid{bottom:28vh; z-index:2}
  .hills-near{bottom:22vh; z-index:3}
  .water{bottom:18vh; z-index:3}
  .buildings{bottom:19vh; z-index:4}
  .stage{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:7;}

  .hills-far .band, .hills-mid .band, .hills-near .band{
    position:absolute; left:-10vw; right:-10vw; height:30vh; border-radius:50%;
  }
  .hills-far .band{background:radial-gradient(120% 70% at 50% 100%, var(--hillFar) 0 60%, transparent 61%)}
  .hills-mid .band{background:radial-gradient(120% 70% at 50% 100%, var(--hillMid) 0 60%, transparent 61%)}
  .hills-near .band{background:radial-gradient(120% 70% at 50% 100%, var(--hillNear) 0 60%, transparent 61%)}

  .water .pond{
    position:absolute; left:62vw; width:24vw; height:9vw; bottom:0;
    background:radial-gradient(60% 70% at 50% 50%, #ccecff 0 60%, var(--pond) 61% 100%);
    border-radius:50%; box-shadow:0 10px 0 #00000010;
  }
  .water .reeds{
    position:absolute; left:calc(62vw + 5vw); bottom:1.6vw; width:12vw; height:6vw;
    background:repeating-linear-gradient(90deg,#6fb866 0 3px, transparent 3px 8px);
    transform:skewX(-10deg); opacity:.85;
  }

  /* Clouds */
  .cloud{position:absolute; top:0; will-change:transform, opacity; opacity:.95; filter:drop-shadow(0 8px 0 #0000000c)}
  .blob{ width:200px; height:80px; background:#fff; border-radius:40px; box-shadow: 60px 0 0 14px #fff, 120px 0 0 10px #fff, -40px 0 0 10px #fff;}
  .wispy{width:240px; height:56px; background:linear-gradient(90deg,#fff 0 60%, #fff8 61%); border-radius:30px/20px}
  .puffy{width:200px; height:70px; background:#fff; border-radius:35px; box-shadow: 0 0 0 10px #fff inset;}
  @keyframes wind-x { from{ transform: translateX(-20vw)} to{ transform: translateX(120vw)} }
  @keyframes wind-y { 0%{transform:translateY(-1vh)} 50%{transform:translateY(1.2vh)} 100%{transform:translateY(-1vh)} }

  /* Buildings (responsive via clamp) */
  .barnWrap{
    position:absolute; left:7vw; bottom:0;
    width: clamp(220px, 24vw, 420px);
    transform-origin: bottom left;
  }
  .windmillWrap{
    position:absolute; left:25vw; bottom:0;
    height: clamp(180px, 26vh, 360px);
    transform-origin: bottom left;
  }
  .coop{
    position:absolute; bottom:0; width: clamp(120px, 14vw, 200px); height: clamp(90px, 10vw, 150px);
    background:var(--wood); border-radius:10px; left:15vw; transform:translateY(8px);
    box-shadow:inset 0 0 0 6px var(--woodDark), 0 6px 0 #00000012;
  }
  .coop:before{content:""; position:absolute; left:0; right:0; margin:auto; top:-56px; width:0; height:0;
               border-left:90px solid transparent; border-right:90px solid transparent; border-bottom:56px solid var(--wood);}
  .coop.duck{left:70vw}

  /* Pop bubbles */
  .pop{position:absolute; display:grid; place-items:center; width:1px; height:1px; transform:translate(-50%,-50%);}
  .bubble{
    display:grid; place-items:center; padding:26px 28px; border-radius:24px;
    background: white; box-shadow:0 18px 50px var(--shadow), inset 0 0 0 6px #0000000e;
    will-change: transform, opacity, filter;
  }
  .emoji{font-size: clamp(84px, 16vw, 180px); line-height:1}
  .name{font-weight:800; margin-top:10px; font-size: clamp(16px, 3.5vw, 26px)}
  .onom{font-size:clamp(13px, 2.8vw, 18px); opacity:.8; margin-top:4px}
  .enter{ animation: enter 1000ms cubic-bezier(.2,.7,.2,1) forwards; }
  @keyframes enter{ 0%{ transform: translateY(18px) scale(.7) rotate(-2deg); opacity:0; filter:blur(2px)} 60%{ transform: translateY(-12px) scale(1.08) rotate(1deg); opacity:1; filter:blur(0)} 100%{ transform: translateY(0) scale(1); opacity:1} }
  .exit{ animation: exit 800ms cubic-bezier(.2,.7,.2,1) forwards; }
  @keyframes exit{ 0%{ transform: translateY(0) scale(1); opacity:1} 100%{ transform: translateY(-24px) scale(.98); opacity:0} }
  .confetti{position:fixed; width:10px; height:10px; border-radius:50%; pointer-events:none;}

  /* HUD, gate, book */
  .hud{position:fixed; left:50%; transform:translateX(-50%); bottom:2vh; z-index:9;
       display:flex; gap:10px; align-items:center; background:var(--panel);
       padding:12px 16px; border-radius:14px; backdrop-filter: blur(6px); pointer-events:auto}
  .hud button, .hud .toggle{border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700; box-shadow:0 4px 0 #00000014; background:#e5e7eb;}
  .hud button.primary{background:#111827; color:white;}
  .label{font-size:12px; opacity:.8; margin-left:6px}
  .range{appearance:none; height:8px; border-radius:6px; background:#e5e7eb; outline:none; width:140px;}
  .range::-webkit-slider-thumb{appearance:none; width:18px; height:18px; border-radius:50%; background:#111827}
  .hint{position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); font-size:clamp(18px,3.2vw,24px); background:var(--panel); padding:10px 14px; border-radius:12px; animation: pulse 2.2s ease-in-out infinite; box-shadow:0 8px 24px #0000001c; z-index:8;}
  @keyframes pulse{0%,100%{opacity:.6} 50%{opacity:1}}
  .gate{position:fixed; inset:0; display:grid; place-items:center; background:#0008; z-index:10}
  .card{background:white; padding:28px; border-radius:18px; text-align:center; width:min(760px,92vw); box-shadow:0 20px 60px #00000033;}
  .title{font-size:clamp(28px,5vw,40px); margin:0 0 8px} .subtitle{margin:0 0 16px; opacity:.8}
  .big{font-size:clamp(20px,3.6vw,28px); padding:14px 18px; border-radius:12px}

  .book{position:fixed; inset:0; background:#0008; z-index:10; display:none; align-items:center; justify-content:center; pointer-events:auto;}
  .book .sheet{background:white; width:min(900px,95vw); max-height:86vh; border-radius:20px; box-shadow:0 20px 60px #00000033; overflow:hidden; display:grid; grid-template-columns: 1fr 2fr; gap:0; position:relative;}
  .book .left{background:#f9fafb; padding:18px; overflow:auto;}
  .book .grid{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px;}
  .book .tile{display:flex; flex-direction:column; align-items:center; justify-content:center; padding:14px; border-radius:14px; background:#fff; box-shadow:0 6px 0 #0000000e; cursor:pointer; user-select:none; transition: transform .15s ease, box-shadow .15s ease, outline-color .15s ease;}
  .book .tile .emo{font-size:42px; line-height:1} .book .tile .nm{font-weight:800; margin-top:6px;}
  .book .tile:hover, .book .tile:focus-visible, .book .tile:active{ transform: translateY(-2px) scale(1.03); box-shadow: 0 8px 0 #00000014, 0 0 0 3px #11182722 inset; outline: none;}
  .book .right{padding:22px; overflow:auto;}
  .book h2{margin:0 0 6px} .book p{margin:8px 0} .book ul{margin:8px 0 0 18px}
  .book .close{position:absolute; top:14px; right:16px; border:0; background:#111827; color:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; box-shadow:0 4px 0 #00000020}
  .book #bookMin{ right:100px; background:#374151; }

  button:focus-visible, input:focus-visible{outline:3px solid #11182788; outline-offset:2px}
</style>
</head>
<body>

<!-- Parallax scene -->
<div class="sky-sun"></div>
<div class="layer clouds" id="cloudLayer"></div>
<div class="layer hills-far"><div class="band" style="transform:translateY(10vh) scale(1.15)"></div></div>
<div class="layer hills-mid"><div class="band" style="transform:translateY(6vh) scale(1.06)"></div></div>
<div class="layer hills-near"><div class="band" style="transform:translateY(2vh) scale(1.02)"></div></div>
<div class="layer water"><div class="pond"></div><div class="reeds"></div></div>

<div class="layer buildings">
  <!-- Barn -->
  <div class="barnWrap">
    <svg viewBox="0 0 260 200" width="100%" height="auto" aria-label="Barn" preserveAspectRatio="xMidYMax meet">
      <ellipse cx="120" cy="192" rx="110" ry="8" fill="#00000018"/>
      <rect x="30" y="70" width="200" height="120" rx="6" fill="url(#barnShade)"/>
      <rect x="30" y="70" width="200" height="120" rx="6" fill="var(--barnBody)" opacity=".93"/>
      <path d="M20,82 L130,20 L240,82 Z" fill="var(--barnRoof)" stroke="var(--barnTrim)" stroke-width="6" />
      <rect x="100" y="110" width="60" height="80" fill="#fff" stroke="var(--barnTrim)" stroke-width="6"/>
      <path d="M100 150h60 M100 110l60 80 M160 110l-60 80" stroke="var(--barnTrim)" stroke-width="6" fill="none"/>
      <rect x="115" y="90" width="30" height="25" fill="#fff" stroke="var(--barnTrim)" stroke-width="5"/>
      <defs><linearGradient id="barnShade" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="var(--barnBodyShade)"/><stop offset="1" stop-color="var(--barnBody)"/></linearGradient></defs>
    </svg>
  </div>

  <!-- Windmill -->
  <div class="windmillWrap">
    <svg viewBox="0 0 120 220" width="auto" height="100%" aria-label="Windmill" preserveAspectRatio="xMidYMax meet">
      <ellipse cx="60" cy="210" rx="40" ry="6" fill="#00000018"/>
      <rect x="52" y="60" width="16" height="140" rx="6" fill="var(--millPost)" stroke="#d1d5db" stroke-width="2"/>
      <rect x="35" y="40" width="50" height="30" rx="6" fill="#e5e7eb" stroke="#d1d5db" stroke-width="2"/>
      <g transform="translate(60,55)">
        <circle r="6" fill="#bdbdbd"/>
        <g style="animation:spin 6s linear infinite; transform-origin:0 0">
          <path d="M0 0 h50 v10 h-50z" fill="var(--millBladeA)" stroke="#d1d5db"/>
          <path d="M0 0 v-50 h10 v50z" fill="var(--millBladeB)" stroke="#d1d5db"/>
          <path d="M0 0 h-50 v-10 h50z" fill="var(--millBladeA)" stroke="#d1d5db"/>
          <path d="M0 0 v50 h-10 v-50z" fill="var(--millBladeB)" stroke="#d1d5db"/>
        </g>
      </g>
    </svg>
  </div>

  <!-- Coops -->
  <div class="coop chicken" title="Chicken coop"></div>
  <div class="coop duck" title="Duck coop"></div>
</div>

<!-- Interactive pops -->
<div class="stage" id="stage" aria-live="polite"></div>

<!-- HUD + Start -->
<div class="hint" id="hint">Tap or press any key 🐮</div>
<div class="gate" id="gate" aria-modal="true" role="dialog">
  <div class="card">
    <h1 class="title">Farm Fun</h1>
    <p class="subtitle">Tap or press any key. Sounds max 3s; newest sound takes over. Touch = keypress.</p>
    <button id="startBtn" class="big">Start</button>
    <div class="tip" style="margin-top:10px; font-size:12px; opacity:.75">
      Sounds live in <code>assets/sfx/&lt;animal&gt;/</code> and are listed in <code>assets/sfx/manifest.json</code>.
    </div>
  </div>
</div>
<div class="hud" aria-label="controls">
  <button id="fsBtn" class="primary" title="Full screen">Full screen</button>
  <span class="label">Volume</span><input id="vol" class="range" type="range" min="0" max="1" step="0.01" value="0.6" />
  <button class="toggle" id="quietBtn" title="Mute all sounds">Quiet: Off</button>
  <button class="toggle" id="sillyBtn" title="Enable/disable silly fallback">Silly sound: On</button>
  <button id="bookBtn" class="toggle" title="Open the Farm Book">📖 Farm Book</button>
</div>

<!-- Book modal -->
<div class="book" id="book">
  <button class="close" id="bookClose">Close ✕</button>
  <button class="close" id="bookMin">Minimise ▾</button>
  <div class="sheet">
    <div class="left"><div class="grid" id="bookGrid"></div></div>
    <div class="right" id="bookContent">
      <h2>Tap an animal to learn</h2>
      <p>With a grown-up, explore sounds, homes, and fun little facts. Big buttons, big smiles.</p>
    </div>
  </div>
</div>

<script>
(() => {
  /* ===== DATA ===== */
  const animals = [
    {name:'Cow', emoji:'🐮', say:'Moo!',    hue:20,  key:'cow'},
    {name:'Pig', emoji:'🐷', say:'Oink!',   hue:340, key:'pig'},
    {name:'Sheep', emoji:'🐑', say:'Baa!',  hue:70,  key:'sheep'},
    {name:'Duck', emoji:'🦆', say:'Quack!', hue:160, key:'duck'},
    {name:'Chicken', emoji:'🐔', say:'Cluck!', hue:35, key:'chicken'},
    {name:'Horse', emoji:'🐴', say:'Neigh!', hue:15, key:'horse'},
    {name:'Goat', emoji:'🐐', say:'Maa!',   hue:60,  key:'goat'},
    {name:'Dog', emoji:'🐶', say:'Woof!',   hue:30,  key:'dog'},
    {name:'Cat', emoji:'🐱', say:'Meow!',   hue:300, key:'cat'},
    {name:'Rabbit', emoji:'🐰', say:'Boing!', hue:200, key:'rabbit'},
  ];
  const DEFAULT_MANIFEST = Object.fromEntries(animals.map(a=>[a.key, []]));
  const BOOK = {
    cow:{title:"Cow",intro:"Cows say “moo!” and love to munch grass.",habitat:"Fields and barns.",facts:["A baby cow is a calf.","Cows chew slowly—chomp, chomp!","They make milk."]},
    pig:{title:"Pig",intro:"Pigs say “oink!” and like soft, squishy mud.",habitat:"Sties on a farm.",facts:["Baby pigs are piglets.","Pigs are smart and curious.","Mud keeps them cool."]},
    sheep:{title:"Sheep",intro:"Sheep say “baa!” and wear fluffy wool coats.",habitat:"Grassy hills and fields.",facts:["A group is a flock.","Baby sheep are lambs.","Wool keeps us warm."]},
    duck:{title:"Duck",intro:"Ducks say “quack!” and splash in water.",habitat:"Ponds and streams.",facts:["Duck feet are webbed.","Ducklings follow in a line.","They shake water off—splish splash!"]},
    chicken:{title:"Chicken",intro:"Chickens say “cluck!” and peck-peck for food.",habitat:"Coops and yards.",facts:["Baby chickens are chicks.","Roosters say “cock-a-doodle-doo!”.","Chickens love grains."]},
    horse:{title:"Horse",intro:"Horses say “neigh!” and run fast.",habitat:"Stables and fields.",facts:["Baby horses are foals.","Horses wear shoes—clip, clop!","They love hay."]},
    goat:{title:"Goat",intro:"Goats say “maa!” and like to climb.",habitat:"Hilly pens and fields.",facts:["Baby goats are kids.","Goats have beards!","They’re great climbers."]},
    dog:{title:"Dog",intro:"Dogs say “woof!” and wag their tails.",habitat:"Homes and farms.",facts:["A puppy is a baby dog.","Dogs are helpful friends.","They love to play."]},
    cat:{title:"Cat",intro:"Cats say “meow!” and curl up cozy.",habitat:"Homes and barns.",facts:["Kittens are baby cats.","Cats purr when happy.","They chase little bugs."]},
    rabbit:{title:"Rabbit",intro:"Rabbits hop and have long ears.",habitat:"Burrows and gardens.",facts:["Baby rabbits are kits.","They nibble greens.","They thump with their feet!"]},
  };

  /* ===== DOM ===== */
  const gate = document.getElementById('gate');
  const startBtn = document.getElementById('startBtn');
  const stage = document.getElementById('stage');
  const hint = document.getElementById('hint');
  const fsBtn = document.getElementById('fsBtn');
  const vol = document.getElementById('vol');
  const quietBtn = document.getElementById('quietBtn');
  const sillyBtn = document.getElementById('sillyBtn');
  const cloudLayer = document.getElementById('cloudLayer');
  const bookBtn = document.getElementById('bookBtn');
  const book = document.getElementById('book');
  const bookClose = document.getElementById('bookClose');
  const bookMin = document.getElementById('bookMin');
  const bookGrid = document.getElementById('bookGrid');
  const bookContent = document.getElementById('bookContent');

  /* ===== AUDIO ===== */
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ctx, masterGain, limiter, softLP, ambienceDelay, ambienceGain;
  let quiet = false, sillyOn = true;
  const bank = {}; let manifest = null; let currentNodes = [];

  function ensureAudio(){
    if (ctx) return;
    ctx = new AudioCtx();
    masterGain = ctx.createGain(); masterGain.gain.value = parseFloat(vol.value);
    softLP = ctx.createBiquadFilter(); softLP.type='lowpass'; softLP.frequency.value=3200; softLP.Q.value=0.5;
    limiter = ctx.createDynamicsCompressor();
    limiter.threshold.value=-14; limiter.knee.value=18; limiter.ratio.value=8; limiter.attack.value=0.003; limiter.release.value=0.12;
    ambienceDelay = ctx.createDelay(0.25); ambienceDelay.delayTime.value=0.07;
    ambienceGain = ctx.createGain(); ambienceGain.gain.value=0.12;
    masterGain.connect(softLP).connect(limiter).connect(ctx.destination);
    softLP.connect(ambienceDelay).connect(ambienceGain).connect(limiter);
  }
  function connectOut(node){ node.connect(masterGain); node.connect(ambienceDelay); }
  vol.addEventListener('input', () => { if(masterGain){ masterGain.gain.value = parseFloat(vol.value);} });
  quietBtn.addEventListener('click', () => { quiet = !quiet; quietBtn.textContent = `Quiet: ${quiet?'On':'Off'}`; });
  sillyBtn.addEventListener('click', () => { sillyOn = !sillyOn; sillyBtn.textContent = `Silly sound: ${sillyOn?'On':'Off'}`; });

  function makeEnv(duration){
    const g = ctx.createGain();
    const now = ctx.currentTime;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.9, now + Math.min(0.05, duration*0.2));
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
    return g;
  }
  function fallbackPlay(key, maxSec){
    if (!sillyOn) return 0;
    const d = Math.min(maxSec, 0.9);
    const o=ctx.createOscillator(); o.type='triangle';
    const g=makeEnv(d); o.connect(g); connectOut(g);
    o.frequency.value = ({cow:120,pig:200,sheep:420,duck:600,chicken:520,horse:240,goat:380,dog:140,cat:360,rabbit:320}[key]||300);
    o.start(); o.stop(ctx.currentTime+d);
    currentNodes.push({src:o, gainNode:g});
    setTimeout(()=>{ currentNodes = currentNodes.filter(n=>n.src!==o); }, (d+0.2)*1000);
    return d;
  }
  function stopCurrentNodes(){
    if (!ctx) return;
    const now = ctx.currentTime;
    currentNodes.forEach(n=>{
      try{
        if (n.gainNode){
          n.gainNode.gain.cancelScheduledValues(now);
          n.gainNode.gain.setValueAtTime(n.gainNode.gain.value, now);
          n.gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
        }
        n.src.stop(now + 0.13);
      }catch(_){}
    });
    currentNodes = [];
  }
  async function fetchManifest(){
    try{
      const res = await fetch('assets/sfx/manifest.json', {cache:'no-cache'});
      if (!res.ok) throw new Error('manifest missing');
      manifest = await res.json();
    }catch(_){ manifest = DEFAULT_MANIFEST; }
  }
  async function decodeAll(){
    ensureAudio();
    for (const a of animals){
      const list = (manifest[a.key]||[]);
      bank[a.key] = [];
      for (const file of list){
        try{
          const url = `assets/sfx/${a.key}/${file}`;
          const ab = await fetch(url).then(r=>r.arrayBuffer());
          const buf = await ctx.decodeAudioData(ab);
          bank[a.key].push(buf);
        }catch(_){}
      }
    }
  }
  function playAnimalSound(key){
    if (!ctx) ensureAudio();
    if (quiet) return 0;
    stopCurrentNodes(); // newest wins
    const list = bank[key] || [];
    const maxDur = 3.0;
    if (list.length){
      const buf = list[(Math.random()*list.length)|0];
      const src = ctx.createBufferSource(); src.buffer = buf;
      const g = ctx.createGain(); g.gain.value = 0.95;
      src.connect(g); connectOut(g);
      const now = ctx.currentTime;
      const playDur = Math.min(buf.duration || maxDur, maxDur);
      g.gain.setValueAtTime(0.95, now + Math.max(0, playDur - 0.15));
      g.gain.exponentialRampToValueAtTime(0.0001, now + playDur);
      src.start(); src.stop(now + playDur + 0.02);
      currentNodes.push({src, gainNode:g});
      setTimeout(()=>{ currentNodes = currentNodes.filter(n=>n.src!==src); }, (playDur+0.2)*1000);
      return playDur;
    }
    return fallbackPlay(key, maxDur);
  }

  /* ===== Pops: non-overlap + max 6 ===== */
  const MAX_POP = 6;
  const activePops = []; // {el,x,y,r}
  function circlesOverlap(a,b){ const dx=a.x-b.x, dy=a.y-b.y; const rr=(a.r+b.r); return dx*dx+dy*dy < rr*rr; }
  function placeNonOverlapping(){
    const r = Math.max(90, Math.min(140, Math.min(innerWidth, innerHeight)*0.12));
    const area = { x0: innerWidth*0.1, x1: innerWidth*0.9, y0: innerHeight*0.22, y1: innerHeight*0.68 };
    for (let tries=0; tries<14; tries++){
      const x = area.x0 + Math.random()*(area.x1-area.x0);
      const y = area.y0 + Math.random()*(area.y1-area.y0);
      const candidate = {x,y,r};
      if (!activePops.some(p => circlesOverlap(p, candidate))) return candidate;
    }
    return null;
  }
  function removeOldest(){
    if (!activePops.length) return;
    const oldest = activePops.shift();
    const bubble = oldest.el.querySelector('.bubble');
    bubble.classList.remove('enter'); bubble.classList.add('exit');
    setTimeout(()=> oldest.el.remove(), 820);
  }

  function burst(x,y,hue){
    const n = 10;
    for(let i=0;i<n;i++){
      const d = document.createElement('div');
      d.className = 'confetti';
      d.style.left=(x)+'px'; d.style.top=(y)+'px'; d.style.position='fixed';
      d.style.background = `hsl(${hue}, 80%, ${60+Math.random()*20}%)`;
      d.style.opacity = 0.95;
      const size = 10 + Math.random()*10; d.style.width = d.style.height = size+'px';
      document.body.appendChild(d);
      const ang = Math.random()*Math.PI*2, dist = 60+Math.random()*110;
      const dx = Math.cos(ang)*dist, dy = Math.sin(ang)*dist;
      const ms = 1200 + Math.random()*600;
      d.animate([{transform:'translate(0,0) scale(1)', opacity:1},{transform:`translate(${dx}px,${dy}px) scale(0.85)`, opacity:0}], {duration: ms, easing:'cubic-bezier(.2,.7,.2,1)', fill:'forwards'});
      setTimeout(()=>d.remove(), ms+120);
    }
  }
  function popAnimalAt(x, y){
    let pos = {x, y};
    const found = placeNonOverlapping();
    if (found) pos = found;
    else {
      if (activePops.length >= MAX_POP) { removeOldest(); const retry = placeNonOverlapping(); if (retry) pos = retry; }
      else return;
    }
    const a = animals[(Math.random()*animals.length)|0];
    playAnimalSound(a.key);

    const node = document.createElement('div');
    node.className = 'pop';
    node.style.left = pos.x + 'px';
    node.style.top  = pos.y + 'px';

    const bubble = document.createElement('div');
    bubble.className = 'bubble enter';
    bubble.style.borderRadius = 22 + Math.random()*12 + 'px';
    bubble.style.filter = `drop-shadow(0 16px 28px var(--shadow))`;
    bubble.style.borderColor = `hsla(${a.hue},70%,35%,.18)`;
    bubble.style.boxShadow += `, 0 0 0 10px hsla(${a.hue}, 90%, 80%, .22) inset`;

    const emoji = document.createElement('div'); emoji.className = 'emoji'; emoji.textContent = a.emoji;
    const name  = document.createElement('div'); name.className  = 'name';  name.textContent = a.name;
    const onom  = document.createElement('div'); onom.className  = 'onom';  onom.textContent = a.say;

    bubble.appendChild(emoji); bubble.appendChild(name); bubble.appendChild(onom);
    node.appendChild(bubble);
    stage.appendChild(node);

    if (activePops.length >= MAX_POP) removeOldest();
    const r = Math.max(90, Math.min(140, Math.min(innerWidth, innerHeight)*0.12));
    activePops.push({el:node, x:pos.x, y:pos.y, r});

    burst(pos.x, pos.y, a.hue);

    setTimeout(() => {
      bubble.classList.remove('enter');
      bubble.classList.add('exit');
      setTimeout(()=> {
        node.remove();
        const i = activePops.findIndex(p => p.el===node);
        if (i>=0) activePops.splice(i,1);
      }, 800);
    }, 3000);
  }

  /* ===== Farm Book: input lock ===== */
  let inputLocked = false;
  function openBook(){ inputLocked = true; book.style.display='flex'; }
  function hideBook(){ book.style.display='none'; inputLocked = false; }

  /* ===== Input handlers (guarded) ===== */
  function triggerFromEvent(e){
    if (inputLocked) return;
    const isPointer = ('clientX' in e);
    if (isPointer) popAnimalAt(e.clientX, e.clientY);
    else {
      const slot = placeNonOverlapping();
      if (slot) popAnimalAt(slot.x, slot.y);
      else if (activePops.length >= MAX_POP) { removeOldest(); const retry = placeNonOverlapping(); if (retry) popAnimalAt(retry.x, retry.y); }
    }
  }

  /* ===== Start, FS, context menu ===== */
  async function begin(){
    ensureAudio();
    await fetchManifest();
    await decodeAll();
    gate.style.display='none';
    hint.style.opacity = 0.75;
    setTimeout(()=>hint.remove(), 2200);
    const slot = placeNonOverlapping(); if (slot) popAnimalAt(slot.x, slot.y);
  }
  startBtn.addEventListener('click', begin);
  window.addEventListener('pointerdown', (e) => { if (gate.style.display !== 'none') begin(); triggerFromEvent(e); }, {passive:true});
  window.addEventListener('keydown',   (e) => { if (gate.style.display !== 'none') begin(); triggerFromEvent(e); }, {passive:true});
  fsBtn.addEventListener('click', async () => { try { if (!document.fullscreenElement) await document.documentElement.requestFullscreen(); else await document.exitFullscreen(); } catch {} });
  window.addEventListener('contextmenu', e => e.preventDefault());

  /* ===== Book UI wiring ===== */
  animals.forEach(a=>{
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.tabIndex = 0;
    tile.innerHTML = `<div class="emo">${a.emoji}</div><div class="nm">${a.name}</div>`;
    const show = ()=>{
      const data = BOOK[a.key] || {title:a.name,intro:"This is a friendly farm animal.",habitat:"On the farm.",facts:["It makes a fun sound!"]};
      bookContent.innerHTML = `
        <h2>${a.emoji} ${data.title}</h2>
        <p>${data.intro}</p>
        <p><strong>Home:</strong> ${data.habitat}</p>
        <p><strong>Sound:</strong> “${a.say}”</p>
        <p><strong>Fun facts:</strong></p>
        <ul>${data.facts.map(f=>`<li>${f}</li>`).join('')}</ul>
        <p style="margin-top:12px; opacity:.8">Tip: With a grown-up, tap the screen to hear the sound.</p>
      `;
    };
    tile.addEventListener('click', show);
    tile.addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); show(); } });
    bookGrid.appendChild(tile);
  });
  bookBtn.addEventListener('click', openBook);
  bookClose.addEventListener('click', hideBook);
  bookMin.addEventListener('click', hideBook);
  window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && book.style.display === 'flex') hideBook(); }, {passive:true});

  /* ===== Procedural clouds ===== */
  function spawnCloud(){
    const types = ['blob','wispy','puffy'];
    const div = document.createElement('div');
    div.className = 'cloud';
    const type = types[(Math.random()*types.length)|0];
    const inner = document.createElement('div'); inner.className = type;
    const scale = 0.7 + Math.random()*1.4;
    div.style.transform = `translateX(-20vw) translateY(${(Math.random()*18)-6}vh) scale(${scale})`;
    const min = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cloudMin'));
    const max = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cloudMax'));
    const dur = min + Math.random()*(max-min);
    div.style.animation = `wind-x ${dur}s linear forwards`;
    inner.style.animation = `wind-y ${8+Math.random()*10}s ease-in-out infinite`;
    div.appendChild(inner);
    cloudLayer.appendChild(div);
    setTimeout(()=>div.remove(), dur*1000 + 2000);
  }
  setInterval(()=>{ if (document.hidden) return; if (cloudLayer.childElementCount < 8) spawnCloud(); }, 2500);
  for(let i=0;i<5;i++) spawnCloud();
})();
</script>

<!--
  SOUND LIBRARY (folders per animal):
  assets/sfx/manifest.json
  assets/sfx/cow/      cow_01.mp3, cow_02.ogg, ...
  assets/sfx/pig/
  assets/sfx/sheep/
  assets/sfx/duck/
  assets/sfx/chicken/
  assets/sfx/horse/
  assets/sfx/goat/
  assets/sfx/dog/
  assets/sfx/cat/
  assets/sfx/rabbit/

  manifest.json example:
  {
    "cow": ["cow_01.mp3","cow_02.mp3"],
    "pig": ["pig_01.mp3"],
    "sheep": [],
    "duck": ["duck_01.mp3"],
    "chicken": ["chicken_01.mp3","chicken_02.mp3"],
    "horse": [],
    "goat": [],
    "dog": [],
    "cat": [],
    "rabbit": []
  }
-->
</body>
</html>
