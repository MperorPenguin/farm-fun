<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Farm Fun ‚Äî Learn & Play (Prototype + Builder)</title>
<style>
  :root{
    --ink:#111827; --panel:#ffffffee; --shadow:#00000026;
    --brand:#0ea5e9; --brand2:#22c55e; --accent:#f59e0b; --danger:#ef4444; --muted:#6b7280;
    --skyTop:#bfe9ff; --skyMid:#aee0ff; --field:#92dc7a;
    --card:#fff; --bg:#f3f4f6;
  }
  html,body{height:100%;margin:0}
  body{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;
    color:var(--ink);
    background: linear-gradient(180deg,var(--skyTop) 0 45%, var(--skyMid) 45% 62%, var(--field) 62% 100%);
    min-height:100svh; min-height:100dvh; overflow:hidden;
    --pad: clamp(12px, 2vw, 20px);
  }
  /* App shell */
  .nav{
    position:fixed; left:0; right:0; top:0; z-index:10;
    display:flex; align-items:center; gap:8px; padding:10px var(--pad);
    background:var(--panel); box-shadow:0 8px 24px var(--shadow); border-bottom:1px solid #e5e7eb;
  }
  .logo{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.3px; cursor:pointer; user-select:none}
  .logo .emoji{font-size:24px}
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tab{border:0; background:#e5e7eb; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:0 3px 0 #00000017}
  .tab.primary{background:#111827; color:#fff}
  .tab.alt{background:#0f172a; color:#fff}
  .tab.warn{background:var(--accent); color:#000}
  .grow{flex:1}
  .right{display:flex; gap:8px}
  .hint{font-size:12px; opacity:.7}
  .wrap{
    position:fixed; inset:64px 0 0 0; padding: var(--pad);
    display:grid; place-items:stretch; overflow:auto;
  }
  .scene{
    position:relative; min-height: calc(100svh - 64px - var(--pad) - env(safe-area-inset-bottom,0px));
    border-radius:18px; background:#0000; overflow:hidden;
  }
  .card{background:var(--card); border-radius:16px; box-shadow:0 14px 40px var(--shadow); padding:clamp(12px,2vw,18px)}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .grid{display:grid; gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width: 740px){ .grid.cols-2,.grid.cols-3,.grid.cols-4{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width: 520px){ .grid.cols-2,.grid.cols-3,.grid.cols-4{ grid-template-columns: repeat(1, minmax(0,1fr)); } }

  /* Farm Book */
  .book-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(110px,1fr)); gap:12px}
  .tile{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:14px; border-radius:14px; background:#fff; box-shadow:0 6px 0 #00000010;
    cursor:pointer; user-select:none; transition:transform .15s ease, box-shadow .15s ease;
  }
  .tile:hover,.tile:active{ transform: translateY(-2px) scale(1.02); box-shadow:0 8px 0 #00000018; }
  .tile .img{width:96px; height:96px; background:#f3f4f6; border-radius:12px; display:grid; place-items:center; overflow:hidden}
  .tile .img img{ width:100%; height:100%; object-fit:contain }
  .tile .nm{font-weight:800; margin-top:8px}

  /* Profile */
  .profile{display:grid; grid-template-columns: 1fr 1.2fr; gap:16px}
  @media (max-width: 860px){ .profile{ grid-template-columns: 1fr; } }
  .bigimg{background:#fff; border-radius:14px; padding:8px; display:grid; place-items:center; min-height:240px}
  .bigimg img{ max-width:100%; max-height:46vh; object-fit:contain }
  .btn{border:0; border-radius:10px; padding:12px 14px; font-weight:800; cursor:pointer; box-shadow:0 4px 0 #00000018}
  .btn.play{ background:var(--brand); color:#fff }
  .btn.secondary{ background:#e5e7eb }
  .btn.ghost{ background:#f3f4f6 }
  .pill{display:inline-flex; gap:8px; padding:8px 10px; border-radius:10px; background:#f3f4f6; align-items:center}
  .fact{padding-left:18px}
  .ok{color:var(--brand2); font-weight:800}
  .oops{color:var(--danger); font-weight:800}

  /* Games */
  .choices{display:grid; grid-template-columns:repeat(auto-fit, minmax(120px,1fr)); gap:12px; margin-top:12px}
  .choice{background:#fff; border-radius:14px; padding:10px; text-align:center; cursor:pointer; box-shadow:0 6px 0 #00000012; transition:transform .15s}
  .choice:hover{ transform: translateY(-2px) }
  .choice .img{ width:120px; height:120px; margin:0 auto; background:#f3f4f6; border-radius:12px; display:grid; place-items:center; overflow:hidden }
  .choice .img img{ width:100%; height:100%; object-fit:contain }

  /* Drag & Drop (What do I eat?) */
  .foods{display:flex; flex-wrap:wrap; gap:10px}
  .food{display:grid; place-items:center; width:88px; height:88px; border-radius:12px; background:#fff; box-shadow:0 6px 0 #00000012; cursor:grab}
  .dropzone{border:2px dashed #cbd5e1; border-radius:12px; padding:10px; min-height:160px; display:grid; place-items:center; color:#64748b}
  .dz-hit{border-color: var(--brand)}

  /* Habitat */
  .hab{ position:relative; border-radius:14px; overflow:hidden; background:linear-gradient(#bfe9ff, #aee0ff 60%, #92dc7a 60%) }
  .zone{ position:absolute; border-radius:12px; outline:2px dashed #ffffff99; outline-offset:-2px; cursor:pointer; background:#0000 }
  .zone:hover{ outline-color:#fff }

  /* Stickers */
  .sticker-board{ position:relative; border-radius:14px; background:#fff; min-height:340px; overflow:hidden; }
  .stickers{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px}
  .sticker{ width:80px; height:80px; border-radius:12px; background:#f3f4f6; display:grid; place-items:center; cursor:grab; box-shadow:0 4px 0 #00000012; }
  .sticker img{ max-width:100%; max-height:100%; object-fit:contain }
  .placed{ position:absolute; width:100px; height:100px; transform:translate(-50%,-50%); cursor:move }

  /* Story */
  .story{ display:grid; gap:10px }
  .story-slide{ display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; align-items:center }
  @media (max-width: 900px){ .story-slide{ grid-template-columns: 1fr; } }
  .story .img{ background:#fff; border-radius:14px; padding:10px; min-height:220px; display:grid; place-items:center }
  .story .img img{ max-width:100%; max-height:46vh; object-fit:contain }

  /* Builder */
  .builder{ position:fixed; inset:0; background:#0008; display:none; align-items:center; justify-content:center; z-index:20 }
  .builder .panel{ background:#fff; width:min(1100px,96vw); max-height:92svh; border-radius:16px; box-shadow:0 24px 80px #0008; display:grid; grid-template-columns: 300px 1fr; overflow:hidden }
  @media (max-width: 960px){ .builder .panel{ grid-template-columns: 1fr; } }
  .b-left{ background:#f8fafc; padding:12px; overflow:auto }
  .b-right{ padding:12px; overflow:auto }
  .uploader{ border:2px dashed #94a3b8; border-radius:14px; padding:14px; text-align:center; cursor:pointer; background:#fff }
  .preview{ display:grid; grid-template-columns:repeat(auto-fill, minmax(90px,1fr)); gap:10px; margin-top:10px }
  .thumb{ background:#f3f4f6; border-radius:10px; display:grid; place-items:center; height:90px; overflow:hidden; position:relative }
  .thumb img{ max-width:100%; max-height:100%; object-fit:contain }
  .thumb .cap{ position:absolute; left:6px; bottom:6px; font-size:10px; background:#0009; color:#fff; padding:2px 6px; border-radius:6px }
  .builder .toolbar{ display:flex; gap:8px; margin:10px 0; flex-wrap:wrap }
  .mini{ font-size:12px; padding:8px 10px; border-radius:8px; border:0; cursor:pointer; font-weight:800; box-shadow:0 3px 0 #00000012 }
  .mini.primary{ background:var(--brand); color:#fff }
  .mini.ghost{ background:#e5e7eb }
  .mini.warn{ background:var(--accent) }
  .mini.danger{ background:var(--danger); color:#fff }

  /* Parent mode badge */
  .badge{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 8px; border-radius:8px; background:#e5e7eb; }
</style>
</head>
<body>

<!-- Top Nav -->
<div class="nav">
  <div class="logo" id="logo" title="Long-press to toggle Parent Mode">
    <div class="emoji">üêÆ</div> <div>Farm Fun</div>
    <span class="badge" id="pmBadge" style="display:none;">Parent Mode</span>
  </div>
  <div class="tabs">
    <button class="tab primary" data-view="book">Farm Book</button>
    <button class="tab" data-view="guess">Sound & Guess</button>
    <button class="tab" data-view="eat">What Do I Eat?</button>
    <button class="tab" data-view="habitat">Habitat Explorer</button>
    <button class="tab" data-view="stickers">Sticker Board</button>
    <button class="tab" data-view="story">Mini Story</button>
  </div>
  <div class="grow"></div>
  <div class="right">
    <button class="tab alt" id="openBuilder">Open Builder</button>
    <span class="hint">Images are your PNGs. Sounds: assets/sfx/&lt;animal&gt;/*.wav/mp3/ogg</span>
  </div>
</div>

<!-- Page wrap -->
<div class="wrap">
  <div class="scene" id="view"></div>
</div>

<!-- Builder Modal -->
<div class="builder" id="builder">
  <div class="panel">
    <div class="b-left">
      <h3 style="margin:6px 0 8px">Assets</h3>
      <div class="card">
        <div class="uploader" id="dropZone">
          Drag & drop PNGs here (or click)
          <input type="file" id="fileInput" accept="image/png" multiple style="display:none">
        </div>
        <p style="font-size:12px; color:#475569; margin:8px 0 0">
          Name files as <code>cow.png</code>, <code>chicken.png</code>, <code>barn.png</code>, <code>coop.png</code>, <code>pond.png</code>, <code>tree_01.png</code>, etc.
        </p>
      </div>
      <div class="toolbar">
        <button class="mini primary" id="saveAssets">Save to Browser</button>
        <button class="mini ghost" id="clearAssets">Clear Saved</button>
        <button class="mini warn" id="exportBuild">Export Build (single HTML)</button>
        <button class="mini" id="closeBuilder">Close</button>
      </div>
      <div class="card">
        <div class="badge" style="background:#e0f2fe;color:#075985">Tip</div>
        <p style="font-size:12px; color:#475569">Saved assets are stored locally (localStorage). Export build bundles them as data‚ÄëURLs.</p>
      </div>
    </div>
    <div class="b-right">
      <h3 style="margin:6px 0 8px">Preview</h3>
      <div class="grid cols-2">
        <div class="card">
          <h4 style="margin:4px 0 10px">Animals</h4>
          <div class="preview" id="prevAnimals"></div>
        </div>
        <div class="card">
          <h4 style="margin:4px 0 10px">Scene</h4>
          <div class="preview" id="prevScene"></div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <h4 style="margin:0 0 8px">Current JSON (read‚Äëonly)</h4>
        <pre id="jsonDump" style="white-space:pre-wrap; font:12px/1.4 ui-monospace,Menlo,monospace; background:#0f172a; color:#e2e8f0; padding:10px; border-radius:10px; max-height:260px; overflow:auto"></pre>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== DATA ====== */
const DEFAULT_ANIMALS = [
  { key:'cow', name:'Cow', say:'Moo!', foods:['hay','grass'], habitat:'barn/field', facts:['A baby cow is a calf.','Cows chew cud.','They give milk.']},
  { key:'pig', name:'Pig', say:'Oink!', foods:['slop','corn'], habitat:'sty', facts:['Baby pigs are piglets.','They like mud.','Pigs are smart.']},
  { key:'sheep', name:'Sheep', say:'Baa!', foods:['grass'], habitat:'field', facts:['A group is a flock.','Babies are lambs.','We get wool.']},
  { key:'duck', name:'Duck', say:'Quack!', foods:['seeds','bugs'], habitat:'pond', facts:['Webbed feet.','Ducklings follow in a line.','They splash!']},
  { key:'chicken', name:'Chicken', say:'Cluck!', foods:['corn','grains'], habitat:'coop', facts:['Baby chickens are chicks.','Roosters crow.','They peck food.']},
  { key:'horse', name:'Horse', say:'Neigh!', foods:['hay','oats'], habitat:'stable', facts:['Babies are foals.','They wear shoes.','They run fast.']},
  { key:'goat', name:'Goat', say:'Maa!', foods:['leaves','hay'], habitat:'pen', facts:['Babies are kids.','They climb.','They nibble.']},
  { key:'dog', name:'Dog', say:'Woof!', foods:['kibble'], habitat:'farmhouse', facts:['Puppies are baby dogs.','Helpful pals.','Love to play.']},
  { key:'cat', name:'Cat', say:'Meow!', foods:['fish','kibble'], habitat:'barnhouse', facts:['Kittens are baby cats.','They purr.','They chase mice.']},
  { key:'rabbit', name:'Rabbit', say:'Hop!', foods:['carrots','greens'], habitat:'hutch', facts:['Babies are kits.','Long ears.','They thump.']},
];

const SCENE_KEYS = ['barn','coop','pond','tree_01','tree_02','fence']; // extend as needed

/* Persistent config (images provided by user) */
const STORAGE_KEY = 'farmfun_assets_v1';
let userAssets = loadAssets();  // { images: {cow: dataURL, ..., barn: dataURL}, meta:{...} }
let parentMode = false;

/* ====== AUDIO (optional real sounds) ====== */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let ctx, masterGain;
const bank = {};  // key ‚Üí [AudioBuffer]
let quiet = false;

function ensureAudio(){
  if (ctx) return;
  ctx = new AudioCtx();
  masterGain = ctx.createGain();
  masterGain.gain.value = .7;
  masterGain.connect(ctx.destination);
}
function connectOut(node){ node.connect(masterGain); }
async function tryFetch(url){
  try{ const r = await fetch(url, {cache:'no-cache'}); return r.ok ? r : null; }catch(e){ return null; }
}
async function autoLoadAnimal(key){
  const exts = ['wav','mp3','ogg'];
  const bases = detectBases();
  bank[key] = bank[key] || [];
  for(let i=1;i<=6;i++){
    for (const ext of exts){
      const nameVar = [`${key}_${String(i).padStart(2,'0')}`,`${key}-${String(i).padStart(2,'0')}`,`${key}${i}`];
      for(const baseName of nameVar){
        for (const base of bases){
          const url = joinPath(base, `assets/sfx/${key}/${baseName}.${ext}`);
          const r = await tryFetch(url);
          if (r){
            const ab = await r.arrayBuffer();
            const buf = await ctx.decodeAudioData(ab);
            bank[key].push(buf);
            break;
          }
        }
      }
    }
  }
}
function playSound(key){
  if (!ctx) ensureAudio();
  const list = bank[key]||[];
  if (!list.length) return;
  const src = ctx.createBufferSource();
  src.buffer = list[(Math.random()*list.length)|0];
  const g = ctx.createGain(); g.gain.value=0.95;
  src.connect(g); connectOut(g);
  const dur = Math.min(src.buffer.duration||2.5, 3.0);
  const now = ctx.currentTime;
  g.gain.setValueAtTime(0.95, now + Math.max(0, dur - .12));
  g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
  src.start(); src.stop(now + dur + .02);
}

/* ====== PATH BASE DETECTION (GitHub Pages friendly) ====== */
function joinPath(base, path){
  if (!base || base === '/') return path.replace(/^\/+/, '');
  return base.replace(/\/+$/,'/') + path.replace(/^\/+/, '');
}
function detectBases(){
  const p = location.pathname;
  const baseDir = p.endsWith('/') ? p : p.replace(/[^/]+$/, '');
  const set = new Map();
  [baseDir, '/', baseDir+'farm-fun/', '/farm-fun/'].forEach(x=>set.set(x,true));
  return [...set.keys()];
}

/* ====== ASSET PIPELINE ====== */
function loadAssets(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { images:{}, meta:{} }; }
  catch(_){ return { images:{}, meta:{} }; }
}
function saveAssets(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(userAssets)); }
function clearAssets(){ localStorage.removeItem(STORAGE_KEY); userAssets = { images:{}, meta:{} }; }

/* Utility to show PNG thumb */
function createThumb(name, dataURL){
  const d = document.createElement('div'); d.className='thumb';
  const img = document.createElement('img'); img.src=dataURL;
  const cap = document.createElement('div'); cap.className='cap'; cap.textContent=name;
  d.appendChild(img); d.appendChild(cap); return d;
}

/* ====== VIEWS ====== */
const view = document.getElementById('view');
const tabs = [...document.querySelectorAll('.tab[data-view]')];
tabs.forEach(t=> t.addEventListener('click', ()=>{ tabs.forEach(x=>x.classList.remove('primary')); t.classList.add('primary'); show(t.dataset.view)}));

function show(which){
  view.innerHTML = '';
  switch(which){
    case 'book': return renderBook();
    case 'guess': return renderGuess();
    case 'eat': return renderEat();
    case 'habitat': return renderHabitat();
    case 'stickers': return renderStickers();
    case 'story': return renderStory();
  }
}

/* ---- Book ---- */
function renderBook(){
  const wrap = document.createElement('div'); wrap.className='card';
  wrap.innerHTML = `<h2 style="margin:0 0 10px">Farm Book</h2><div class="book-grid" id="bookGrid"></div>`;
  view.appendChild(wrap);
  const grid = wrap.querySelector('#bookGrid');
  DEFAULT_ANIMALS.forEach(a=>{
    const tile = document.createElement('div'); tile.className='tile';
    tile.innerHTML = `<div class="img">${imgFor(a.key,96)}</div><div class="nm">${a.name}</div>`;
    tile.addEventListener('click', ()=>openProfile(a.key));
    grid.appendChild(tile);
  });
}
function imgFor(key, size=120){
  const url = userAssets.images[key] || '';
  if (url) return `<img alt="${key}" src="${url}" width="${size}" height="${size}">`;
  // fallback SVG icon
  const emoji = {cow:'üêÆ',pig:'üê∑',sheep:'üêë',duck:'ü¶Ü',chicken:'üêî',horse:'üê¥',goat:'üêê',dog:'üê∂',cat:'üê±',rabbit:'üê∞'}[key]||'üåæ';
  return `<div style="font-size:${Math.round(size*0.7)}px; line-height:1">${emoji}</div>`;
}
function openProfile(key){
  const animal = DEFAULT_ANIMALS.find(a=>a.key===key);
  if (!animal) return;
  view.innerHTML='';
  const card = document.createElement('div'); card.className='card profile';
  card.innerHTML = `
    <div class="bigimg">${imgFor(key, 360)}</div>
    <div>
      <h2 style="margin:0">${animal.name} <span class="pill"><strong>Sound:</strong> ${animal.say}</span></h2>
      <div class="row" style="margin:10px 0 6px">
        <button class="btn play" id="playBtn">Play Sound</button>
        <button class="btn secondary" id="backBtn">Back to Book</button>
      </div>
      <p><strong>Home:</strong> ${animal.habitat}</p>
      <p><strong>Food:</strong> ${animal.foods.join(', ')}</p>
      <p><strong>Fun facts:</strong></p>
      <ul class="fact">${animal.facts.map(f=>`<li>${f}</li>`).join('')}</ul>
      ${parentMode ? `<div style="margin-top:10px"><span class="badge">Parent Tip</span> Ask your child to mimic the sound and count legs (1‚Ä¶2‚Ä¶3‚Ä¶4).</div>`:''}
    </div>`;
  view.appendChild(card);
  card.querySelector('#playBtn').addEventListener('click', ()=>{ ensureAudio(); autoLoadAnimal(key).then(()=>playSound(key)); awardSticker(key); });
  card.querySelector('#backBtn').addEventListener('click', ()=>show('book'));
}

/* ---- Sound & Guess ---- */
function renderGuess(){
  const state = { target: randomAnimal().key, options: pickOptions(3) };
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `
    <h2 style="margin:0 0 6px">Sound & Guess</h2>
    <p>Listen, then tap the animal you hear.</p>
    <button class="btn play" id="play">Play Sound</button>
    <div class="choices" id="choices"></div>
    <div id="msg" style="margin-top:8px; font-weight:800"></div>
  `;
  view.appendChild(card);
  const ch = card.querySelector('#choices');
  state.options.forEach(k=>{
    const btn = document.createElement('div'); btn.className='choice';
    btn.innerHTML = `<div class="img">${imgFor(k,120)}</div><div style="margin-top:6px; font-weight:800">${nameFromKey(k)}</div>`;
    btn.addEventListener('click', ()=>{
      if (k===state.target){ card.querySelector('#msg').innerHTML = `<span class="ok">Correct!</span>`; awardSticker(k); state.target = randomAnimal().key; setTimeout(()=>renderGuess(), 900); }
      else { card.querySelector('#msg').innerHTML = `<span class="oops">Try again!</span>`; }
    });
    ch.appendChild(btn);
  });
  card.querySelector('#play').addEventListener('click', ()=>{ ensureAudio(); autoLoadAnimal(state.target).then(()=>playSound(state.target)); });
}

/* ---- What Do I Eat? (drag & drop) ---- */
function renderEat(){
  const animal = randomAnimal();
  const foodsUnique = uniq(DEFAULT_ANIMALS.flatMap(a=>a.foods));
  const wrong = foodsUnique.filter(f=>!animal.foods.includes(f)).sort(()=>Math.random()-0.5).slice(0,3);
  const options = shuffle([...animal.foods, ...wrong]).slice(0,4);

  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `
    <h2 style="margin:0 0 6px">What Do I Eat?</h2>
    <div class="grid cols-2">
      <div class="bigimg"><div>${imgFor(animal.key, 260)}</div><div style="margin-top:8px; font-weight:800; text-align:center">${animal.name}</div></div>
      <div>
        <div class="dropzone" id="dz">Drop the foods here</div>
        <div class="foods" id="foods"></div>
        <div id="msg" style="margin-top:8px; font-weight:800"></div>
      </div>
    </div>`;
  view.appendChild(card);
  const dz = card.querySelector('#dz');
  const foods = card.querySelector('#foods');
  makeDZ(dz);
  options.forEach(f=>{
    const el = document.createElement('div'); el.className='food'; el.textContent = f; el.draggable=true;
    el.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', f));
    foods.appendChild(el);
  });
  dz.addEventListener('drop', e=>{
    const f = e.dataTransfer.getData('text/plain');
    if (animal.foods.includes(f)){ card.querySelector('#msg').innerHTML = `<span class="ok">Yes! ${animal.name} eats ${f}.</span>`; awardSticker(animal.key); setTimeout(()=>renderEat(), 900); }
    else { card.querySelector('#msg').innerHTML = `<span class="oops">Not usually. Try again!</span>`; }
  });
}

/* ---- Habitat Explorer ---- */
function renderHabitat(){
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<h2 style="margin:0 0 6px">Habitat Explorer</h2>
    <div class="hab" id="hab" style="height: clamp(280px, 48vh, 520px)">
      ${sceneImg('barn', 'left:8%; bottom:8%; width:22%')}
      ${sceneImg('coop', 'left:30%; bottom:8%; width:18%')}
      ${sceneImg('pond', 'right:12%; bottom:6%; width:26%')}
      ${sceneImg('tree_01', 'left:6%; top:8%; width:10%')}
      ${sceneImg('tree_02', 'right:8%; top:6%; width:10%')}
      <div class="zone" data-hab="barn"   style="left:8%; bottom:8%; width:22%; height:24%"></div>
      <div class="zone" data-hab="coop"   style="left:30%; bottom:8%; width:18%; height:22%"></div>
      <div class="zone" data-hab="pond"   style="right:12%; bottom:6%; width:26%; height:24%"></div>
      <div class="zone" data-hab="field"  style="left:52%; bottom:14%; width:20%; height:18%"></div>
    </div>
    <div id="out" style="margin-top:8px; font-weight:800"></div>`;
  view.appendChild(card);
  card.querySelectorAll('.zone').forEach(z=>{
    z.addEventListener('click', ()=>{
      const hab = z.dataset.hab;
      const hits = DEFAULT_ANIMALS.filter(a=> (a.habitat||'').includes(hab) || (hab==='field' && a.habitat.includes('field')));
      const out = hits.length ? hits.map(a=>a.name).join(', ') : 'No animals here';
      card.querySelector('#out').textContent = `Here you‚Äôll find: ${out}`;
    });
  });
}
function sceneImg(key, style){
  const url = userAssets.images[key];
  if (!url) return '';
  return `<img src="${url}" alt="${key}" style="position:absolute; ${style}; pointer-events:none">`;
}

/* ---- Sticker Board ---- */
function renderStickers(){
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `
    <h2 style="margin:0 0 6px">Sticker Board</h2>
    <div class="sticker-board" id="board">
      ${sceneImg('barn', 'left:6%; bottom:6%; width:22%')}
      ${sceneImg('coop', 'left:30%; bottom:6%; width:18%')}
      ${sceneImg('pond', 'right:12%; bottom:6%; width:26%')}
    </div>
    <div class="stickers" id="palette"></div>
    <div style="margin-top:10px" class="row">
      <button class="btn secondary" id="clearPlaced">Clear Board</button>
    </div>`;
  view.appendChild(card);
  const pal = card.querySelector('#palette');
  ownedStickers().forEach(k=>{
    const s = document.createElement('div'); s.className='sticker'; s.innerHTML = imgFor(k, 80);
    s.draggable=true;
    s.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', k));
    pal.appendChild(s);
  });
  const board = card.querySelector('#board');
  board.addEventListener('dragover', e=>{ e.preventDefault(); });
  board.addEventListener('drop', e=>{
    e.preventDefault();
    const k = e.dataTransfer.getData('text/plain');
    if (!k) return;
    const el = document.createElement('div'); el.className='placed'; el.innerHTML = imgFor(k, 100);
    el.style.left = e.offsetX + 'px'; el.style.top = e.offsetY + 'px';
    makeDraggable(el, board);
    board.appendChild(el);
  });
  card.querySelector('#clearPlaced').addEventListener('click', ()=>{ [...board.querySelectorAll('.placed')].forEach(x=>x.remove()); });
}

/* ---- Mini Story ---- */
function renderStory(){
  const steps = [
    {img:'barn', text:'Good morning! The sun is up on the farm.'},
    {img:'coop', text:'The chickens cluck, ‚ÄúGood day!‚Äù'},
    {img:'pond', text:'At the pond, ducks go ‚Äúquack, quack!‚Äù'},
    {img:'cow', text:'Cow says ‚Äúmoo!‚Äù It‚Äôs breakfast time.'},
  ];
  let i=0;
  const card = document.createElement('div'); card.className='card story';
  card.innerHTML = `
    <div class="story-slide">
      <div class="img" id="simg">${storyImg(steps[i].img)}</div>
      <div><h3 id="stxt" style="margin:0 0 10px">${steps[i].text}</h3>
        <div class="row"><button class="btn play" id="next">Next</button>
        <button class="btn secondary" id="repeat">Repeat</button></div>
      </div>
    </div>`;
  view.appendChild(card);
  function setStep(){
    card.querySelector('#simg').innerHTML = storyImg(steps[i].img);
    card.querySelector('#stxt').textContent = steps[i].text;
  }
  card.querySelector('#next').addEventListener('click', ()=>{ i=(i+1)%steps.length; setStep(); });
  card.querySelector('#repeat').addEventListener('click', setStep);
}
function storyImg(key){ return userAssets.images[key] ? `<img src="${userAssets.images[key]}">` : imgFor(key, 280); }

/* ===== helpers ===== */
function randomAnimal(){ return DEFAULT_ANIMALS[(Math.random()*DEFAULT_ANIMALS.length)|0]; }
function nameFromKey(k){ return DEFAULT_ANIMALS.find(a=>a.key===k)?.name || k; }
function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((p,q)=>p[0]-q[0]).map(p=>p[1]); }
function uniq(a){ return [...new Set(a)]; }
function pickOptions(n){
  const target = randomAnimal().key;
  const all = DEFAULT_ANIMALS.map(a=>a.key).filter(k=>k!==target);
  const others = shuffle(all).slice(0, n-1);
  return shuffle([target, ...others]);
}
function makeDZ(el){
  el.addEventListener('dragover', e=>{ e.preventDefault(); el.classList.add('dz-hit'); });
  el.addEventListener('dragleave', ()=> el.classList.remove('dz-hit'));
  el.addEventListener('drop', e=>{ e.preventDefault(); el.classList.remove('dz-hit'); handleFiles(e.dataTransfer.files); });
}
function makeDraggable(el, container){
  let dragging=false, ox=0, oy=0;
  el.addEventListener('pointerdown', e=>{ dragging=true; ox=e.clientX- el.offsetLeft; oy=e.clientY - el.offsetTop; el.setPointerCapture(e.pointerId); });
  el.addEventListener('pointermove', e=>{
    if(!dragging) return;
    const x = Math.max(0, Math.min(container.clientWidth, e.clientX-ox));
    const y = Math.max(0, Math.min(container.clientHeight, e.clientY-oy));
    el.style.left=x+'px'; el.style.top=y+'px';
  });
  el.addEventListener('pointerup', ()=> dragging=false);
}

/* ====== BUILDER ====== */
const builder = document.getElementById('builder');
document.getElementById('openBuilder').addEventListener('click', ()=>{ builder.style.display='flex'; renderBuilder(); });
document.getElementById('closeBuilder').addEventListener('click', ()=> builder.style.display='none');

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
dropZone.addEventListener('click', ()=> fileInput.click());
dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.classList.add('dz-hit'); });
dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('dz-hit'));
dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.classList.remove('dz-hit'); handleFiles(e.dataTransfer.files); });
fileInput.addEventListener('change', e=> handleFiles(e.target.files));

function handleFiles(list){
  const files = [...list].filter(f=>/\.png$/i.test(f.name));
  Promise.all(files.map(f=>readAsDataURL(f).then(dataURL=>{
    const base = f.name.replace(/\.png$/i,'').toLowerCase(); // e.g., cow, barn, tree_01
    userAssets.images[base] = dataURL;
  }))).then(()=> renderBuilder());
}
function readAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

function renderBuilder(){
  // previews
  const prevA = document.getElementById('prevAnimals'); prevA.innerHTML='';
  DEFAULT_ANIMALS.forEach(a=>{
    const key = a.key;
    const src = userAssets.images[key];
    prevA.appendChild(createThumb(key, src || placeholderData(key)));
  });
  const prevS = document.getElementById('prevScene'); prevS.innerHTML='';
  SCENE_KEYS.forEach(k=>{
    const src = userAssets.images[k];
    if (src) prevS.appendChild(createThumb(k, src));
  });
  document.getElementById('jsonDump').textContent = JSON.stringify(userAssets, null, 2);
}
document.getElementById('saveAssets').addEventListener('click', ()=>{ saveAssets(); renderBuilder(); alert('Saved to browser.'); });
document.getElementById('clearAssets').addEventListener('click', ()=>{ if(confirm('Remove saved assets?')){ clearAssets(); renderBuilder(); } });

/* ===== EXPORT BUILD =====
   Generates a single-file HTML with user images embedded as data-URLs.
   In the export, the Builder is disabled by default for a ‚Äúpublish‚Äù build.
*/
document.getElementById('exportBuild').addEventListener('click', ()=>{
  const pkg = {
    images: userAssets.images,
    meta: {} // reserved for future (copy, localised text, etc.)
  };
  const html = buildExportHTML(pkg);
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'farm-app-export.html';
  document.body.appendChild(a); a.click(); a.remove();
});

/* Build export: embeds lightweight runtime + your images */
function buildExportHTML(pkg){
  const data = JSON.stringify(pkg);
  return `<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Farm Fun ‚Äî Build</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;background:#f3f4f6;color:#111827}
.wrap{max-width:920px;margin:24px auto;padding:0 14px}
.card{background:#fff;border-radius:14px;box-shadow:0 14px 40px #0003;padding:16px}
.btn{border:0;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer;box-shadow:0 4px 0 #0002}
.btn.primary{background:#111827;color:#fff}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
.tile{background:#f8fafc;border-radius:12px;padding:8px;display:grid;place-items:center}
.tile img{max-width:100%;max-height:120px;object-fit:contain}
</style></head>
<body>
<div class="wrap">
  <div class="card">
    <h1 style="margin:0 0 8px">Farm Fun</h1>
    <p style="margin:0 0 10px">This is your exported build. The Builder is disabled. Assets are embedded.</p>
    <button class="btn primary" id="launch">Launch App</button>
  </div>
  <div class="card" style="margin-top:12px">
    <h3 style="margin:0 0 8px">Embedded Asset Preview</h3>
    <div class="grid" id="prev"></div>
  </div>
</div>
<script>
  const EMBED = ${data};
  const prev = document.getElementById('prev');
  Object.entries(EMBED.images).forEach(([k,v])=>{
    const d=document.createElement('div');d.className='tile';d.innerHTML='<div>'+k+'</div><img src="'+v+'">';prev.appendChild(d);
  });
  document.getElementById('launch').addEventListener('click',()=>{
    // Minimal runtime that loads EMBED.images into the app and hides builder.
    const w = window.open('','_blank');
    w.document.write('<!DOCTYPE html>'+document.documentElement.outerHTML);
    w.document.close();
    w.addEventListener('load', ()=>{
      try{
        w.localStorage.setItem('${STORAGE_KEY}', JSON.stringify({images: EMBED.images, meta:{}}));
      }catch(_){}
      // Remove Builder triggers
      const ob = w.document.getElementById('openBuilder'); if (ob) ob.style.display='none';
    }, {once:true});
  });
</script>
</body></html>`;
}

/* Placeholder (emoji raster) if no user image yet */
function placeholderData(key){
  // Tiny canvas data URL so previews look consistent
  const e = {cow:'üêÆ',pig:'üê∑',sheep:'üêë',duck:'ü¶Ü',chicken:'üêî',horse:'üê¥',goat:'üêê',dog:'üê∂',cat:'üê±',rabbit:'üê∞'}[key]||'üåæ';
  const c = document.createElement('canvas'); c.width=256; c.height=256;
  const g = c.getContext('2d'); g.fillStyle='#f1f5f9'; g.fillRect(0,0,256,256);
  g.font='180px serif'; g.textAlign='center'; g.textBaseline='middle'; g.fillText(e,128,140);
  return c.toDataURL('image/png');
}

/* ====== Parent Mode (long-press logo) ====== */
const logo = document.getElementById('logo');
let pressT=null;
logo.addEventListener('pointerdown', ()=>{ pressT = setTimeout(()=>{ parentMode = !parentMode; document.getElementById('pmBadge').style.display = parentMode?'inline-flex':'none'; }, 900); });
logo.addEventListener('pointerup', ()=>{ if (pressT){ clearTimeout(pressT); pressT=null; }});

/* ====== INIT ====== */
tabs[0].click(); // show Book by default
</script>
</body>
</html>
